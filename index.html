<script>
    // ... (keep all your existing style and head content exactly the same) ...

    const canvas = document.getElementById('paint-canvas');
    const ctx = canvas.getContext('2d');
    let painting = false;
    let penColor = '#000000';
    let penSize = 5;
    let history = [];
    let historyStep = -1;

    // Initialize canvas with white background
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    history.push(canvas.toDataURL());
    historyStep++;

    function startPosition(e) {
      painting = true;
      draw(e);
    }

    function endPosition() {
      painting = false;
      ctx.beginPath();
      saveState();
    }

    function draw(e) {
      if (!painting) return;
      ctx.lineWidth = penSize;
      ctx.lineCap = 'round';
      ctx.strokeStyle = penColor;

      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      ctx.lineTo(x, y);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(x, y);
    }

    function saveState() {
      if (historyStep < history.length - 1) {
        history = history.slice(0, historyStep + 1);
      }
      history.push(canvas.toDataURL());
      historyStep++;
    }

    // Event Listeners
    canvas.addEventListener('mousedown', startPosition);
    canvas.addEventListener('mouseup', endPosition);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseout', endPosition);

    document.getElementById('color-picker').addEventListener('input', (e) => {
      penColor = e.target.value;
    });

    document.getElementById('pen-size').addEventListener('input', (e) => {
      penSize = e.target.value;
    });

    document.getElementById('brush-tool').addEventListener('click', () => {
      penColor = document.getElementById('color-picker').value;
    });

    document.getElementById('eraser-tool').addEventListener('click', () => {
      penColor = '#FFFFFF';
    });

    document.getElementById('undo-tool').addEventListener('click', () => {
      if (historyStep > 0) {
        historyStep--;
        restoreCanvas();
      }
    });

    document.getElementById('redo-tool').addEventListener('click', () => {
      if (historyStep < history.length - 1) {
        historyStep++;
        restoreCanvas();
      }
    });

    function restoreCanvas() {
      const canvasPic = new Image();
      canvasPic.onload = function() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(canvasPic, 0, 0);
      };
      canvasPic.src = history[historyStep];
    }

    document.getElementById('save-tool').addEventListener('click', () => {
      const link = document.createElement('a');
      link.download = 'penda-drawing.png';
      link.href = canvas.toDataURL('image/png').replace('image/png', 'image/octet-stream');
      link.click();
    });

    document.getElementById('clear-tool').addEventListener('click', () => {
      ctx.fillStyle = 'white';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      saveState();
    });

    // ... (keep all your remaining HTML exactly the same) ...
</script>
